Refactor router to be loosely coupled